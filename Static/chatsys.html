<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clay Hacker Chat</title>
<style>
  body { background:#000; color:#fff; font-family:Poppins,sans-serif;
         display:flex; flex-direction:column; height:100vh; margin:0; }
  #chatBox { flex:1; overflow-y:auto; padding:15px; }
  #chatBox div { margin-bottom:10px; }
  .user { color:#0af; font-weight:600; }
  .system { color:#777; font-style:italic; }
  form { display:flex; padding:10px; background:#111; }
  input[type=text] { flex:1; padding:10px; border:2px solid #333;
                     border-radius:10px; background:transparent; color:#fff; }
  button { margin-left:10px; border:2px solid #555; background:transparent;
           color:#fff; border-radius:10px; padding:10px 16px; cursor:pointer; }
  button:hover { background:#111; }
  #profileBtn { position:absolute; top:15px; right:15px; }
</style>
</head>
<body>
  <button id="profileBtn">✏️ Edit Nickname</button>
  <div id="chatBox"></div>
  <form id="chatForm">
    <input id="msgInput" type="text" placeholder="Type message..." autocomplete="off" />
    <button type="submit">Send</button>
  </form>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
async function checkLogin(){
  const res = await fetch("/api/me");
  if(!res.ok){
    alert("Please login or signup to join chat.");
    location.href="login.html";
  }
}
checkLogin();

const socket = io();
const chatBox = document.getElementById("chatBox");
const form = document.getElementById("chatForm");
const input = document.getElementById("msgInput");

socket.on("chat", data=>{
  const div=document.createElement("div");
  div.innerHTML=`<span class='user'>${data.user}</span>: ${data.msg}`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

socket.on("system", data=>{
  const div=document.createElement("div");
  div.className="system";
  div.textContent=data.msg;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
});

form.addEventListener("submit", e=>{
  e.preventDefault();
  if(input.value.trim()!==""){
    socket.emit("message",{msg:input.value});
    input.value="";
  }
});

document.getElementById("profileBtn").onclick = async ()=>{
  const nickname = prompt("Enter new nickname:");
  if(!nickname) return;
  const res = await fetch("/api/profile", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({nickname})
  });
  const data = await res.json();
  alert(data.message || data.error);
};
</script>
</body>
</html>
